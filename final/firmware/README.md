# Firmware Integration Notes

This folder contains parameter export artifacts and C interface boundaries for the ESP32 implementation.

## Loop Split
- Inner loop: FOC/current control at high rate (driver or dedicated high-priority task).
- Outer loop: deterministic 250 Hz estimator + delta-u LQR + integral base correction.

## Data Flow (250 Hz)
1. Read latest IMU + encoder snapshots.
2. Validate freshness and sequence monotonicity.
3. Estimator predict with previous effective command.
4. Estimator update with measurement vector `[pitch, roll, pitch_rate, roll_rate, wheel_rate]`.
5. Compute control delta and apply `max_du`, integrate to command, apply `max_u`.
6. Apply actuator guards (wheel dynamic torque, speed limits, base derate).
7. If any safety violation occurs, cut torque immediately and latch fault.

## Safety Latch
Faults are latched and require explicit re-arm/reset:
- tilt limit
- angular-rate limit
- control deadline misses over threshold
- IMU staleness
- undervoltage/overcurrent

## Parameters
`controller_params.h` is generated by `final/export_firmware_params.py` and is parity-locked to `final/final.py` semantics for `smooth` and `robust` profiles.

For conservative bring-up on real hardware, generate with:
`python final/export_firmware_params.py --mode robust --real-hardware --out final/firmware/controller_params.h`

Before flashing, run:
- `python -m pytest final/test_export_parity.py -q`
- `python -m pytest final/test_firmware_scenario_parity.py -q`

Use `control_loop_safety_check(...)` each outer-loop tick to enforce:
- command timeout watchdog (`CTRL_CMD_TIMEOUT_US`)
- tilt trip debounce (`CTRL_TILT_TRIP_COUNT`, `CTRL_CRASH_ANGLE_RAD`)

## Sim-to-Real Process

- Runbook: `docs/SIM_TO_REAL_WORKFLOW.md`
- Discrepancy log template: `docs/SIM_TO_REAL_DISCREPANCY_LOG.md`
- Sensitivity analyzer: `final/sim2real_sensitivity.py`
